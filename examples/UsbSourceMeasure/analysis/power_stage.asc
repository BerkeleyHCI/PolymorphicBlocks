Version 4.1
SHEET 1 2092 1408
WIRE -432 -192 -464 -192
WIRE -320 -192 -352 -192
WIRE -176 -176 -208 -176
WIRE -576 -128 -608 -128
WIRE -464 -128 -464 -192
WIRE -464 -128 -496 -128
WIRE -464 -96 -464 -128
WIRE -432 -96 -464 -96
WIRE -320 -80 -320 -192
WIRE -320 -80 -368 -80
WIRE -288 -80 -320 -80
WIRE -176 -80 -176 -176
WIRE -176 -80 -208 -80
WIRE -432 -64 -464 -64
WIRE -576 -32 -608 -32
WIRE -464 -32 -464 -64
WIRE -464 -32 -496 -32
WIRE 880 0 832 0
WIRE -464 16 -464 -32
WIRE -432 16 -464 16
WIRE -320 16 -352 16
WIRE 432 16 400 16
WIRE 832 32 832 0
WIRE 832 32 784 32
WIRE 864 32 832 32
WIRE 832 64 832 32
WIRE 880 64 832 64
WIRE 64 112 64 16
WIRE 96 112 64 112
WIRE 192 112 160 112
WIRE 208 112 208 16
WIRE 208 112 192 112
WIRE 400 112 400 16
WIRE 432 112 400 112
WIRE 544 112 512 112
WIRE 928 112 928 80
WIRE -272 160 -272 80
WIRE -272 160 -464 160
WIRE -160 160 -192 160
WIRE 1520 160 1488 160
WIRE 1632 160 1600 160
WIRE -1056 192 -1056 160
WIRE -960 192 -960 160
WIRE -960 192 -1056 192
WIRE -864 192 -864 160
WIRE -864 192 -960 192
WIRE -720 192 -752 192
WIRE -624 192 -640 192
WIRE -608 192 -624 192
WIRE -496 192 -528 192
WIRE 400 208 400 112
WIRE 432 208 400 208
WIRE -1056 224 -1056 192
WIRE -960 224 -960 192
WIRE -864 224 -864 192
WIRE -464 224 -464 160
WIRE -432 224 -464 224
WIRE 544 224 544 112
WIRE 544 224 496 224
WIRE 576 224 544 224
WIRE 672 224 656 224
WIRE 784 224 784 32
WIRE 784 224 752 224
WIRE 800 224 784 224
WIRE 928 224 928 192
WIRE 1072 224 928 224
WIRE 1136 224 1072 224
WIRE 1280 224 1216 224
WIRE 1488 224 1488 160
WIRE 1488 224 1456 224
WIRE -272 240 -368 240
WIRE -160 240 -160 160
WIRE -160 240 -192 240
WIRE -64 240 -160 240
WIRE 64 240 64 112
WIRE 64 240 16 240
WIRE 96 240 64 240
WIRE 432 240 400 240
WIRE 1216 240 1216 224
WIRE -496 256 -496 192
WIRE -432 256 -496 256
WIRE 192 256 192 112
WIRE 192 256 160 256
WIRE 400 256 400 240
WIRE 400 256 192 256
WIRE 928 256 928 224
WIRE 1488 256 1488 224
WIRE 1520 256 1488 256
WIRE 96 272 64 272
WIRE 1632 272 1632 160
WIRE 1632 272 1584 272
WIRE 1664 272 1632 272
WIRE 1728 272 1664 272
WIRE -496 288 -496 256
WIRE -496 288 -528 288
WIRE 752 288 752 224
WIRE 752 288 720 288
WIRE 1520 288 1488 288
WIRE 1072 320 1072 304
WIRE 1136 320 1072 320
WIRE 1216 320 1216 304
WIRE 1280 320 1376 224
WIRE 1280 320 1216 320
WIRE 1376 320 1280 224
WIRE 1488 320 1488 288
WIRE 1488 320 1456 320
WIRE 928 368 928 336
WIRE 1488 368 1488 320
WIRE 1520 368 1488 368
WIRE 1632 368 1600 368
WIRE 880 384 832 384
WIRE -336 400 -464 400
WIRE -272 400 -336 400
WIRE -160 400 -160 240
WIRE -160 400 -192 400
WIRE 784 416 784 224
WIRE 832 416 832 384
WIRE 832 416 784 416
WIRE 864 416 832 416
WIRE -720 432 -752 432
WIRE -624 432 -640 432
WIRE -608 432 -624 432
WIRE -496 432 -528 432
WIRE 832 448 832 416
WIRE 880 448 832 448
WIRE -464 464 -464 400
WIRE -432 464 -464 464
WIRE -336 480 -336 464
WIRE -336 480 -368 480
WIRE -160 480 -160 400
WIRE -160 480 -272 480
WIRE -496 496 -496 432
WIRE -432 496 -496 496
WIRE 1312 496 1280 496
WIRE 1424 496 1392 496
WIRE -336 512 -336 480
WIRE -320 512 -336 512
WIRE -496 528 -496 496
WIRE -496 528 -528 528
WIRE 1280 560 1280 496
WIRE 1280 560 1248 560
WIRE 1280 592 1280 560
WIRE 1312 592 1280 592
WIRE 1424 608 1424 496
WIRE 1424 608 1376 608
WIRE 1456 608 1424 608
WIRE 1520 608 1456 608
WIRE -336 624 -464 624
WIRE -272 624 -336 624
WIRE -160 624 -160 480
WIRE -160 624 -192 624
WIRE 1312 624 1280 624
WIRE -720 656 -752 656
WIRE -624 656 -640 656
WIRE -608 656 -624 656
WIRE -496 656 -528 656
WIRE 1072 656 1072 320
WIRE 1072 656 1008 656
WIRE 1168 656 1072 656
WIRE 1280 656 1280 624
WIRE 1280 656 1248 656
WIRE -464 688 -464 624
WIRE -432 688 -464 688
WIRE -336 704 -336 688
WIRE -336 704 -368 704
WIRE -160 704 -160 624
WIRE -160 704 -272 704
WIRE 1280 704 1280 656
WIRE 1312 704 1280 704
WIRE 1424 704 1392 704
WIRE -496 720 -496 656
WIRE -432 720 -496 720
WIRE 1072 736 1072 656
WIRE -496 752 -496 720
WIRE -496 752 -528 752
WIRE 1008 816 1008 800
FLAG 928 -16 +V
FLAG -864 304 -V
FLAG -864 80 +V
FLAG -1056 224 0
FLAG 1552 304 -V
FLAG 464 192 +V
FLAG 1072 656 out
FLAG -624 192 vsig
FLAG 1072 816 0
FLAG -960 80 +Vdd
FLAG -400 208 +Vdd
FLAG -1056 80 +Vref
FLAG 1456 608 vsen
FLAG -960 304 -Vdd
FLAG 128 224 +Vdd
FLAG 1168 560 0
FLAG -608 288 vsen
FLAG 64 272 +Vref
FLAG 1424 704 +Vref
FLAG 512 16 +Vref
FLAG -400 448 +Vdd
FLAG -608 528 isen
FLAG -752 432 +Vref
FLAG 128 288 -Vdd
FLAG -400 272 -Vdd
FLAG -400 512 -Vdd
FLAG -752 192 +Vref
FLAG -624 432 i+sig
FLAG -400 672 +Vdd
FLAG -608 752 isen
FLAG -752 656 +Vref
FLAG -400 736 -Vdd
FLAG -624 656 i-sig
FLAG 192 112 vint
FLAG 1664 272 isen
FLAG 1632 368 +Vref
FLAG 1344 640 -V
FLAG 1344 576 +V
FLAG 1552 240 +V
FLAG 464 256 -V
FLAG 928 464 -V
FLAG -320 16 +Vref
FLAG -400 -48 -V
FLAG -400 -112 +V
FLAG -608 -128 out
FLAG -608 -32 drive
FLAG 544 224 drive
FLAG 784 32 gate
FLAG -288 -176 +Vref
FLAG 1008 816 0
FLAG 720 368 0
FLAG 720 288 x
FLAG -64 384 0
FLAG -176 -80 voff
FLAG -64 480 sel
FLAG -64 560 0
FLAG -192 80 +Vref
FLAG -160 160 verr
SYMBOL voltage -864 64 R0
SYMATTR InstName V1
SYMATTR Value 20
SYMBOL voltage -864 208 R0
SYMATTR InstName V2
SYMATTR Value 3.3
SYMBOL res 1056 208 R0
SYMATTR InstName Rsen
SYMATTR Value 1
SYMBOL res 912 240 R0
SYMATTR InstName R2
SYMATTR Value 0
SYMBOL res 912 96 R0
SYMATTR InstName R3
SYMATTR Value 0
SYMBOL voltage -960 64 R0
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V4
SYMATTR Value 3.3
SYMBOL voltage -1056 64 R0
SYMATTR InstName V5
SYMATTR Value 1.65
SYMBOL res 528 96 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R7
SYMATTR Value 20k
SYMBOL res 416 32 R270
WINDOW 0 32 56 VTop 2
WINDOW 3 0 56 VBottom 2
SYMATTR InstName R8
SYMATTR Value 1k
SYMBOL voltage -960 208 R0
SYMATTR InstName V7
SYMATTR Value 0
SYMBOL cap 160 96 R90
WINDOW 0 0 32 VBottom 2
WINDOW 3 32 32 VTop 2
SYMATTR InstName C4
SYMATTR Value 6.8n
SYMBOL res 1408 480 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R15
SYMATTR Value 10k
SYMBOL res 1264 544 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R16
SYMATTR Value 240k
SYMBOL res 1264 640 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R17
SYMATTR Value 240k
SYMBOL res 1408 688 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R18
SYMATTR Value 10k
SYMBOL res -512 272 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R9
SYMATTR Value 10k
SYMBOL res -512 176 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R10
SYMATTR Value 10k
SYMBOL res -512 512 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R20
SYMATTR Value 10k
SYMBOL res -512 416 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R21
SYMATTR Value 10k
SYMBOL diode -336 496 R270
WINDOW 0 32 32 VTop 2
WINDOW 3 0 32 VBottom 2
SYMATTR InstName D3
SYMATTR Value 1N4148
SYMBOL res -176 224 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R23
SYMATTR Value 4.7k
SYMBOL voltage -624 432 R90
WINDOW 0 -32 56 VBottom 2
WINDOW 3 32 56 VTop 2
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V10
SYMATTR Value -1
SYMBOL res 32 224 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R12
SYMATTR Value 4.7k
SYMBOL res 672 208 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R1
SYMATTR Value 45
SYMBOL voltage -624 192 R90
WINDOW 0 -32 56 VBottom 2
WINDOW 3 32 56 VTop 2
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V6
SYMATTR Value -.2
SYMBOL res -512 736 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R4
SYMATTR Value 10k
SYMBOL res -512 640 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R5
SYMATTR Value 10k
SYMBOL diode -272 688 R90
WINDOW 0 0 32 VBottom 2
WINDOW 3 32 32 VTop 2
SYMATTR InstName D1
SYMATTR Value 1N4148
SYMBOL voltage -624 656 R90
WINDOW 0 -32 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName V3
SYMATTR Value 1
SYMBOL res 1616 144 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R11
SYMATTR Value 50k
SYMBOL res 1472 208 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R13
SYMATTR Value 10k
SYMBOL res 1472 304 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R14
SYMATTR Value 10k
SYMBOL res 1616 352 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R19
SYMATTR Value 50k
SYMBOL res 1056 720 R0
SYMATTR InstName Rload2
SYMATTR Value 40
SYMBOL pmos 880 464 M180
SYMATTR InstName M3
SYMATTR Value RSJ250P10
SYMBOL nmos 880 -16 R0
SYMATTR InstName M4
SYMATTR Value IRLH5030
SYMBOL res -336 -208 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R24
SYMATTR Value 10k
SYMBOL res -480 -144 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R25
SYMATTR Value 200k
SYMBOL res -480 -48 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R26
SYMATTR Value 200k
SYMBOL res -336 0 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R27
SYMATTR Value 10k
SYMBOL schottky 928 208 R90
WINDOW 0 -4 32 VBottom 2
WINDOW 3 36 32 VTop 2
SYMATTR InstName D2
SYMATTR Value 1N5817
SYMATTR Description Zener Diode
SYMATTR Type zener
SYMBOL schottky 800 240 R270
WINDOW 0 36 32 VTop 2
WINDOW 3 -4 32 VBottom 2
SYMATTR InstName D4
SYMATTR Value 1N5817
SYMATTR Description Zener Diode
SYMATTR Type zener
SYMBOL res -192 -96 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R28
SYMATTR Value 10k
SYMBOL res -192 -192 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R29
SYMATTR Value 10k
SYMBOL res 1232 208 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R30
SYMATTR Value 100
SYMBOL res 1232 304 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R31
SYMATTR Value 100
SYMBOL cap 1200 240 R0
SYMATTR InstName C1
SYMATTR Value 470p
SYMBOL OpAmps\\UniversalOpAmp3a 464 224 R0
SYMATTR InstName U9
SYMATTR Value2 Avol=300Meg GBW=14Meg Slew=20Meg
SYMATTR SpiceLine Ilimit=25m Rail=0 Vos=0 Phimargin=60
SYMATTR SpiceLine2 En=5.2 Enk=0 In=0 Ink=0 Rin=500Meg
SYMBOL OpAmps\\UniversalOpAmp3a 1552 272 R0
SYMATTR InstName U7
SYMATTR Value2 Avol=1Meg GBW=500k Slew=1Meg
SYMATTR SpiceLine Ilimit=25m Rail=0 Vos=0 Phimargin=60
SYMATTR SpiceLine2 En=110n Enk=0 In=0 Ink=0 Rin=500Meg
SYMBOL OpAmps\\UniversalOpAmp3a 1344 608 R0
SYMATTR InstName U8
SYMATTR Value2 Avol=1Meg GBW=500k Slew=1Meg
SYMATTR SpiceLine Ilimit=25m Rail=0 Vos=0 Phimargin=60
SYMATTR SpiceLine2 En=110n Enk=0 In=0 Ink=0 Rin=500Meg
SYMBOL diode -352 400 R0
SYMATTR InstName D5
SYMATTR Value 1N4148
SYMBOL diode -320 688 R180
WINDOW 0 24 64 Left 2
WINDOW 3 24 0 Left 2
SYMATTR InstName D6
SYMATTR Value 1N4148
SYMBOL res -176 384 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R32
SYMATTR Value 4.7k
SYMBOL res -176 608 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R33
SYMATTR Value 4.7k
SYMBOL OpAmps\\UniversalOpAmp3b -400 480 R0
SYMATTR InstName U2
SYMATTR Value2 Avol=1Meg GBW=4.5Meg Slew=20Meg
SYMATTR SpiceLine Ilimit=75m Rail=0 Vos=0 Phimargin=60
SYMATTR SpiceLine2 En=10.8n Enk=0 In=0 Ink=0 Rin=500Meg
SYMBOL OpAmps\\UniversalOpAmp3b -400 704 R0
SYMATTR InstName U1
SYMATTR Value2 Avol=1Meg GBW=4.5Meg Slew=20Meg
SYMATTR SpiceLine Ilimit=75m Rail=0 Vos=0 Phimargin=60
SYMATTR SpiceLine2 En=10.8n Enk=0 In=0 Ink=0 Rin=500Meg
SYMBOL OpAmps\\UniversalOpAmp3b -400 240 R0
SYMATTR InstName U3
SYMATTR Value2 Avol=1Meg GBW=4.5Meg Slew=20Meg
SYMATTR SpiceLine Ilimit=75m Rail=0 Vos=0 Phimargin=60
SYMATTR SpiceLine2 En=10.8n Enk=0 In=0 Ink=0 Rin=500Meg
SYMBOL OpAmps\\UniversalOpAmp3b -400 -80 R0
SYMATTR InstName U4
SYMATTR Value2 Avol=1Meg GBW=4.5Meg Slew=20Meg
SYMATTR SpiceLine Ilimit=75m Rail=0 Vos=0 Phimargin=60
SYMATTR SpiceLine2 En=10.8n Enk=0 In=0 Ink=0 Rin=500Meg
SYMBOL OpAmps\\UniversalOpAmp3b 128 256 R0
SYMATTR InstName U5
SYMATTR Value2 Avol=1Meg GBW=4.5Meg Slew=20Meg
SYMATTR SpiceLine Ilimit=75m Rail=0 Vos=0 Phimargin=60
SYMATTR SpiceLine2 En=10.8n Enk=0 In=0 Ink=0 Rin=500Meg
SYMBOL voltage 768 224 R90
WINDOW 0 -32 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName Vi
SYMATTR Value AC {u(-prb)}
SYMBOL current 720 368 R180
WINDOW 0 24 80 Left 2
WINDOW 3 24 0 Left 2
SYMATTR InstName Ii
SYMATTR Value AC {u(prb)}
SYMBOL cap 128 0 R90
WINDOW 0 0 32 VBottom 2
WINDOW 3 32 32 VTop 2
WINDOW 39 28 32 VBottom 2
SYMATTR InstName C2
SYMATTR Value 33n
SYMBOL res 224 0 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R35
SYMATTR Value 150
SYMBOL cap 992 736 R0
SYMATTR InstName C3
SYMATTR Value 100µ
SYMBOL bv -64 288 R0
SYMATTR InstName B1
SYMATTR Value V = V(verr)*V(sel) + V(voff)*(1-V(sel))
SYMBOL voltage -64 464 R0
WINDOW 0 -32 56 VBottom 2
WINDOW 3 32 56 VTop 2
WINDOW 123 0 0 Left 0
WINDOW 39 0 0 Left 0
SYMATTR InstName V8
SYMATTR Value PULSE(0 1 500u 1n)
SYMBOL res -176 144 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R6
SYMATTR Value 47k
SYMBOL res -176 64 R90
WINDOW 0 0 56 VBottom 2
WINDOW 3 32 56 VTop 2
SYMATTR InstName R22
SYMATTR Value 1k
TEXT 408 -72 Left 2 ;Driver Amplifier\n(HV opamp)
TEXT 880 -80 Left 2 ;Driver
TEXT -440 128 Left 2 ;Voltage Control
TEXT 88 -72 Left 2 ;Error\nIntegrator
TEXT -440 368 Left 2 ;Source Control
TEXT 1456 440 Left 2 ;1/24 V/V differential voltage sense\n(re-centering 0V -> +Vref, HV opamp)
TEXT -1056 -8 Left 2 ;Voltage Rails
TEXT 1272 440 Left 2 ;Voltage Sense
TEXT 1656 96 Left 2 ;Current sense (5V/V)\n(HV opamp)
TEXT 1480 104 Left 2 ;Current Sense
TEXT -472 -248 Left 2 ;Off-state feedback
TEXT 24 472 Left 2 !.step param prb list -1 1\n.ac dec 10 1k 1Meg\n;.param prb=1\n;.tran 3ms uic
TEXT 24 600 Left 2 !; This uses the Tian method for loop gain / phase analysis,\n; see LTSpice examples/Educational/LoopGain2.asc\n.func T() -1/(1-1/(2*(I(Vi)@1*V(x)@2-V(x)@1*I(Vi)@2)+V(x)@1+I(Vi)@2))
TEXT -192 128 Left 2 ;TODO: the 4.7k output resistance couples into Rin of the compensator\nincreasing gain by 2x, which is compensated with the lower gain here
